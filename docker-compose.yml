version: '3.8'
services:
  agent:
    build: .
    image: scion-agent:latest
    container_name: nextgen_agent_dev
    # Set the working directory to the writable workspace
    working_dir: /app/workspace
    
    # CRITICAL CHANGE: Use a shell script to copy source files ONCE before starting the agent
    command: >
      /bin/sh -c "
      echo 'Initializing workspace from source...' &&
      cp -R /app/src/. /app/workspace/ &&
      echo 'Workspace ready. Starting Agent.' &&
      python3 /app/workspace/core/agent_core.py
      "
      
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    volumes:
      # src is mounted read-only (ro) to guarantee source integrity
      - ./src:/app/src:ro
      # workspace is writable for execution, modification, and tertiary files
      - ./workspace:/app/workspace
    restart: unless-stopped