#!/bin/bash

# --- CONFIGURATION ---
SERVICE_NAME="agent"
# ---

echo "--- DEPLOYMENT START: $(date) ---"
echo ""

# --- 1. Robust Container Management (Stop/Remove Old Instance) ---
echo "1. Ensuring clean container slate (stopping/removing any running/paused instance)..."
docker-compose stop "$SERVICE_NAME" 2>/dev/null || true
docker-compose rm -f "$SERVICE_NAME" 2>/dev/null || true

# --- 2. Workspace Cleanup (Code Directories) ---
echo "2. Cleaning ALL workspace code/framework directories to prevent clutter..."
rm -rf workspace/core/*
rm -rf workspace/secondary/*

# --- 3. Copy Source Code (Executable Code) ---
echo "3. Copying clean source code to the CORRECT executable directories (workspace/core/ and workspace/secondary/)..."

# Ensure the executable directories exist directly under workspace
mkdir -p workspace/core
mkdir -p workspace/secondary
mkdir -p workspace/data

# Copy source files for core and secondary logic
# Note: Using cp -a preserves permissions if set, but we will explicitly enforce below.
cp -a src/core/. workspace/core/
cp -a src/secondary/. workspace/secondary/

# --- 4. Enforce Immutability (Read-Only Core Logic) ---
echo "4. Enforcing Read-Only permissions on Core Logic (workspace/core/)..."
# Set files to read-only (444) for user, group, and others. This prevents the agent from writing/modifying.
chmod 444 workspace/core/*

# --- 5. Operational Data Persistence Logic ---
echo "5. Syncing operational data structure to workspace/data/ (copying only new/missing files)..."

# Iterate over all files in src/data/ and copy them ONLY if they do not exist
for data_file in src/data/*; do
    if [ -f "$data_file" ]; then
        filename=$(basename "$data_file")
        target_path="workspace/data/$filename"

    if [ ! -f "$target_path" ]; then
            echo "Copying new data file: $filename"
            cp "$data_file" "$target_path"
        else
            echo "Data file already exists: $filename (Retained for persistence)"
        fi
    fi
done

# --- 6. Build and Run Docker Container ---
echo "6. Building and running Docker container..."
docker-compose up --build -d

echo ""
echo "--- DEPLOYMENT COMPLETE ---"